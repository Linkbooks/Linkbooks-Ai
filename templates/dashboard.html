{% extends "layout.html" %}

{% block title %}Dashboard - Linkbooks Ai{% endblock %}

{% block content %}

<div class="dashboard-container">
    <!-- Hidden input for chatSessionId -->
    <input type="hidden" id="chatSessionId" value="{{ chatSessionId }}">

    <header style="margin-top: 0px;">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="App Logo"
            style="max-width: 100px; margin-bottom: 10px;">
        <h1>Linkbooks Ai</h1>
    </header>

    <div style="width: 80px; height: 2px; background-color: green; margin: 20px auto; border-radius: 1px;"></div>

    <h2 class="dashboard-title">Dashboard</h2>
    <div class="container">
        {% if quickbooks_login_needed %}
            <div class="alert alert-warning">
                <strong>⚠️ QuickBooks not connected.</strong>
                <p>You need to log in with QuickBooks to access your data.</p>
                <a id="quickbooks-login-button" href="/quickbooks-login?chatSessionId={{ chatSessionId }}" class="button">
                    Log in with QuickBooks
                </a>
            </div>
        {% else %}
            <div class="alert alert-success">
                <strong>✅ QuickBooks Connected!</strong>
                <p>You are successfully connected to QuickBooks.</p>
            </div>

            {% if not quickbooks_linked_to_chat %}
                <div class="alert alert-danger">
                    <strong>⚠️ QuickBooks is not linked to ChatGPT.</strong>
                    <p>You're connected to QuickBooks, but this session is not linked to ChatGPT. Log in through ChatGPT to use QuickBooks data in conversations.</p>
                </div>
            {% endif %}
        {% endif %}

        <!-- Display Success Message -->
        {% if success_message %}
        <div id="qb-success-banner" class="message success-message">
            <p>QuickBooks authorization successful!</p>
            <button id="qb-success-close" style="margin-left: 20px;">×</button>
        </div>
        {% endif %}

        <!-- Dashboard Status Section -->
        <div class="status-container">
            <h3>Connection Status</h3>
            <p>QuickBooks: <span id="quickbooks-status">Checking...</span></p>
            {% if not quickbooks_login_needed and not quickbooks_linked_to_chat %}
                <p class="warning-text" style="color: red;">
                ⚠️ QuickBooks is connected but NOT linked to ChatGPT. 
                <a href="#" id="quickbooks-help-link" style="color: blue; text-decoration: underline;">Help</a>
            </p>
        {% endif %}


            <p>OpenAI: <span id="openai-status">Checking...</span></p>
        </div>

        <!-- Buttons Section -->
        <div class="button-container">
            <button onclick="fetchReports()">List Available Reports</button>
            <button onclick="openWhatElseModal()">What else can I do?</button>
        </div>

        <!-- Modal for "What else can I do?" -->
        <div id="what-else-modal">
            <div id="what-else-modal-content"></div>
            <button onclick="closeWhatElseModal()">Close</button>
        </div>

        <!-- Additional Elements -->
        <div id="response-container"></div>
    </div>
    <!-- Modal for Report Details -->
    <div id="modal">
        <div id="modal-content"></div>
        <button onclick="closeModal()">Close</button>
    </div>

    <script>
        // Update QuickBooks status display on page load
    document.addEventListener('DOMContentLoaded', function () {
        const quickbooksStatus = document.getElementById('quickbooks-status');
        const quickbooksLoginButton = document.getElementById('quickbooks-login-button');
    
        const quickbooksLoginNeeded = "{{ quickbooks_login_needed }}" === "True";
        const quickbooksLinkedToChat = "{{ quickbooks_linked_to_chat }}" === "True";

        if (!quickbooksLoginNeeded) {
            quickbooksStatus.innerText = 'Connected';
            if (quickbooksLoginButton) quickbooksLoginButton.style.display = 'none';

            // If connected but NOT linked to ChatGPT, show warning
            if (!quickbooksLinkedToChat) {
                quickbooksStatus.innerHTML += `<span style="color: red;"> ⚠️ Not linked to ChatGPT</span>`;
            }
        } else {
            quickbooksStatus.innerText = 'Disconnected';
            if (quickbooksLoginButton) quickbooksLoginButton.style.display = 'inline-block';
        }
    });

        

        // Check OpenAI connection status
        async function checkOpenAI() {
            try {
                const response = await fetch('/test-openai');
                const result = await response.json();
                if (response.ok) {
                    document.getElementById('openai-status').innerText = 'Connected';
                } else {
                    document.getElementById('openai-status').innerText = 'Disconnected';
                }
            } catch {
                document.getElementById('openai-status').innerText = 'Disconnected';
            }
        }

        // Run connection checks on load
        document.addEventListener('DOMContentLoaded', () => {
            checkQuickBooks();
            checkOpenAI();
        });

        // Dynamically update the QuickBooks login button with chatSessionId
        document.addEventListener('DOMContentLoaded', function () {
            const button = document.getElementById('quickbooks-login-button');
            const urlParams = new URLSearchParams(window.location.search);
            const chatSessionId = urlParams.get('chatSessionId');

            if (chatSessionId) {
                button.href = `/quickbooks-login?chatSessionId=${encodeURIComponent(chatSessionId)}`;
            }
        });

        // Authorisation Success Closable Banner
        document.addEventListener('DOMContentLoaded', function () {
            const closeBtn = document.getElementById('qb-success-close');
            const qbStatus = document.getElementById('quickbooks-status');
            const qbLoginButton = document.getElementById('quickbooks-login-button');
            const banner = document.getElementById('qb-success-banner');

            if (banner) {
                // If QuickBooks success banner is shown, update status and hide login button
                qbStatus.innerText = 'Connected';
                if (qbLoginButton) {
                    qbLoginButton.style.display = 'none';
                }

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        banner.style.display = 'none';
                    });
                }
            }
        });


        function openWhatElseModal() {
            const modal = document.getElementById('what-else-modal');
            const modalContent = document.getElementById('what-else-modal-content');

            // Set modal content with what the user can do
            modalContent.innerHTML = `
                <h2>What Else Can I Do?</h2>
                <p>Linkbooks AI offers several powerful features:</p>
                <ul>
                    <li>Generate business insights from your financial data</li>
                    <li>Create detailed reports and summaries</li>
                    <li>Connect and analyze data from QuickBooks</li>
                    <li>Use AI-powered chat to ask questions about your business</li>
                </ul>
            `;

            modal.style.display = 'block';
        }

        function closeWhatElseModal() {
            const modal = document.getElementById('what-else-modal');
            modal.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const helpLink = document.getElementById('quickbooks-help-link');
            const modal = document.getElementById('quickbooks-help-modal');
            const closeModal = document.getElementById('close-quickbooks-help');
        
            if (helpLink) {
                helpLink.addEventListener('click', function (event) {
                    event.preventDefault(); // Prevent default anchor behavior
                    modal.style.display = 'block';
                });
            }
        
            if (closeModal) {
                closeModal.addEventListener('click', function () {
                    modal.style.display = 'none';
                });
            }
        });
        
    </script>

        <!-- QuickBooks Help Modal -->
    <div id="quickbooks-help-modal" class="modal">
        <div class="modal-content">
            <h2>QuickBooks ChatGPT Link Help</h2>
            <p>Your QuickBooks account is connected, but it's not linked to this ChatGPT session.</p>
            <p>To use QuickBooks data in ChatGPT, you need to log in through ChatGPT and connect your QuickBooks account there.</p>
            <p><strong>Solution:</strong></p>
            <ul>
                <li>Go back to ChatGPT and start a new conversation.</li>
                <li>Click the "Log in with QuickBooks" button from ChatGPT.</li>
                <li>Ensure you're using the same QuickBooks account.</li>
            </ul>
            <button id="close-quickbooks-help">Close</button>
        </div>
    </div>
</div>
{% endblock %}