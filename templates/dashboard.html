{% extends "layout.html" %}

{% block title %}Dashboard - Linkbooks Ai{% endblock %}

{% block content %}

<div class="dashboard-container">
    <!-- Hidden input for chatSessionId -->
    <input type="hidden" id="chatSessionId" value="{{ chatSessionId }}">

    <header style="margin-top: 0px;">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="App Logo"
            style="max-width: 100px; margin-bottom: 10px;">
        <h1>Linkbooks Ai</h1>
    </header>

    <div style="width: 80px; height: 2px; background-color: green; margin: 20px auto; border-radius: 1px;"></div>

    <h2 class="dashboard-title">Dashboard</h2>
    <div class="container">
        {% if quickbooks_login_needed %}
        <div class="quickbooks-login-prompt">
            <p>You need to log in with QuickBooks to access your data.</p>
            <a id="quickbooks-login-button" href="/quickbooks-login?chatSessionId={{ chatSessionId }}" class="button">
                Log in with QuickBooks
            </a>
        </div>
        {% endif %}

        <!-- Display Success Message -->
        {% if success_message %}
        <div id="qb-success-banner" class="message success-message">
            <p>QuickBooks authorization successful!</p>
            <button id="qb-success-close" style="margin-left: 20px;">Ã—</button>
        </div>
        {% endif %}

        <!-- Dashboard Status Section -->
        <div class="status-container">
            <h3>Connection Status</h3>
            <p>QuickBooks: <span id="quickbooks-status">Checking...</span></p>
            <p>OpenAI: <span id="openai-status">Checking...</span></p>
        </div>

        <!-- Buttons Section -->
        <div class="button-container">
            <button onclick="fetchReports()">List Available Reports</button>
            <button onclick="openWhatElseModal()">What else can I do?</button>
        </div>

        <!-- Modal for "What else can I do?" -->
        <div id="what-else-modal">
            <div id="what-else-modal-content"></div>
            <button onclick="closeWhatElseModal()">Close</button>
        </div>

        <!-- Additional Elements -->
        <div id="response-container"></div>
    </div>
    <!-- Modal for Report Details -->
    <div id="modal">
        <div id="modal-content"></div>
        <button onclick="closeModal()">Close</button>
    </div>

    <script>
        // Check QuickBooks connection status
        async function checkQuickBooks() {
            try {
                const response = await fetch('/business-info');
                if (response.ok) {
                    // success
                    document.getElementById('quickbooks-status').innerText = 'Connected';
                    document.getElementById('quickbooks-login-button').style.display = 'none';
                } else {
                    // failure
                    document.getElementById('quickbooks-status').innerText = 'Disconnected';
                    document.getElementById('quickbooks-login-button').style.display = 'inline-block';
                }
            } catch {
                // network or other error
                document.getElementById('quickbooks-status').innerText = 'Disconnected';
                document.getElementById('quickbooks-login-button').style.display = 'inline-block';
            }
        }

        // Check OpenAI connection status
        async function checkOpenAI() {
            try {
                const response = await fetch('/test-openai');
                const result = await response.json();
                if (response.ok) {
                    document.getElementById('openai-status').innerText = 'Connected';
                } else {
                    document.getElementById('openai-status').innerText = 'Disconnected';
                }
            } catch {
                document.getElementById('openai-status').innerText = 'Disconnected';
            }
        }

        // Run connection checks on load
        document.addEventListener('DOMContentLoaded', () => {
            checkQuickBooks();
            checkOpenAI();
        });

        // Dynamically update the QuickBooks login button with chatSessionId
        document.addEventListener('DOMContentLoaded', function () {
            const button = document.getElementById('quickbooks-login-button');
            const urlParams = new URLSearchParams(window.location.search);
            const chatSessionId = urlParams.get('chatSessionId');

            if (chatSessionId) {
                button.href = `/quickbooks-login?chatSessionId=${encodeURIComponent(chatSessionId)}`;
            }
        });

        // Authorisation Success Closable Banner
        document.addEventListener('DOMContentLoaded', function () {
            const closeBtn = document.getElementById('qb-success-close');
            const qbStatus = document.getElementById('quickbooks-status');
            const qbLoginButton = document.getElementById('quickbooks-login-button');
            const banner = document.getElementById('qb-success-banner');

            if (banner) {
                // If QuickBooks success banner is shown, update status and hide login button
                qbStatus.innerText = 'Connected';
                if (qbLoginButton) {
                    qbLoginButton.style.display = 'none';
                }

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        banner.style.display = 'none';
                    });
                }
            }
        });


        function openWhatElseModal() {
            const modal = document.getElementById('what-else-modal');
            const modalContent = document.getElementById('what-else-modal-content');

            // Set modal content with what the user can do
            modalContent.innerHTML = `
                <h2>What Else Can I Do?</h2>
                <p>Linkbooks AI offers several powerful features:</p>
                <ul>
                    <li>Generate business insights from your financial data</li>
                    <li>Create detailed reports and summaries</li>
                    <li>Connect and analyze data from QuickBooks</li>
                    <li>Use AI-powered chat to ask questions about your business</li>
                </ul>
            `;

            modal.style.display = 'block';
        }

        function closeWhatElseModal() {
            const modal = document.getElementById('what-else-modal');
            modal.style.display = 'none';
        }
    </script>
</div>
{% endblock %}